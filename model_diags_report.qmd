---
title: "SS3 Model Checks Test run"
author: "Michelle Sculley"
date: "`r Sys.Date()`"
format: html
params: 
  species: "SWO"
  scenario: "base"
  profile: "R0"
  profile_vec: !expr seq(5,7,0.2)
  Njitter: !expr 2
---

```{r setup}
#| include: false
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE, 
                      warning=FALSE)
library(this.path)
library(r4ss)
library(ss3diags)
library(tidyverse)
library(gt)


```

**This is a summary report for the `r params$species` `r params$scenario` model run.**

```{r}

report. <- SS_output(dir = model.info$out_dir, verbose = FALSE, printstats = FALSE)

```

# Model Output

::: panel-tabset
## Input Data

```{r }
#| label: dataplot
source(file.path(base.dir,"Rscripts","001_LoadModel.R"))
SSplotData(base.model,plot=TRUE, print=FALSE, subplots = 2, pheight=8,pwidth=10, margins = c(5.1,2.1,2.1,18.1), ptsize=6) 
```

## Convergence Check

```{r}
data.frame(Converged = file.exists(file.path(getwd(), "ss.std")), 
           MaxGrad = report.$maximum_gradient_component)

report.$warnings
```

## Fit to Model

### CPUE

```{r}
#| label: indexfits
#| fig-show: hold
#| message: false
#| fig-align: center


## CPUE expected vs obs, runs test, RSME output
source(file.path(base.dir,"Rscripts","003_DataSummaryFigs.R"))
ExpectedCPUE

sspar(mfrow=c(4,2),plot.cex = 0.8)
SSplotRunstest(report.,subplots="cpue",add=T,cex.main = 0.8, verbose = FALSE)

 SSrmse(report., quants = "cpue")$RMSE %>% gt()

```

### Length Comp

```{r}
SSrmse(report., quants = "len")$RMSE %>% gt()
```

```{r}
#| label: lenfits
#| fig-show: hold
#| message: false
#| fig-align: center
#| layout-ncol: 2

ylim <- SSrunstest(report., quants = "len", verbose = F, add=T)
sspar(mfrow = c(1,2), omi = c(.35,.3,.1,.1), mai = c(.6,.55,.1,.1))
SSMethod.TA1.8(report., type = "len", set.pars = F, fleet = 1, printit = F, plotadj = F)
SSplotRunstest(report., subplots = "len", add = TRUE, indexselect = 1, 
               ylim = c(min(ylim$sigma3.lo), max(ylim$sigma3.hi)), verbose = F)


```

```{r}
#| label: lencompfits
#| fig-align: center
sspar(mfrow = c(1,2))
SSplotComps(report., subplots = 21)
SSplotComps(report., subplots = 1)
SSplotComps(report., subplots = 24)

```

## Retrospective and Hindcasting

### Retrospective

```{r }
#| message: false
#| eval: true
#| error: true
#| label: retrospectives
if(dir.exists(file.path(getwd(), "Retrospectives"))){
  
source(file.path(base.dir,"Rscripts","006_Run_Retrospective.R"))
 sspar(mfrow=c(2,2),plot.cex = 0.9)
  Retro1<-SSplotRetro(retroSummary,forecast = F,add=T,showrho = F,subplots = c("SSB", "F")[1], verbose=FALSE, legendloc = "bottomright") # SSB
  Retro2<-SSplotRetro(retroSummary,forecast = F,add=T,showrho = F,subplots = c("SSB", "F")[2],legend = F, verbose=FALSE) # F
  Retro3<-SSplotRetro(retroSummary,xmin=2000,forecastrho = T,add=T,legend = F, verbose=FALSE)
  Retro4<-SSplotRetro(retroSummary,xmin=2000,forecastrho = T,add=T,legend = F,subplots="F", verbose=FALSE)
}else{
  print("No retrospective runs were found")
}

```

### Hindcasting

```{r}
#| label: hindcast
#| eval: true
#| error: true

if(dir.exists(file.path(getwd(), "Retrospectives"))){
  
  sspar(mfrow = c(1,2))
  SSplotHCxval(retrosum, subplots = "cpue", add = TRUE, indexselect = 1, legendloc = "bottomleft")
  SSplotHCxval(retrocomp, subplots = "len", add = TRUE, indexselect = 1, legend = F)
  ## can use this if you have multiple indices or length comp fleets
  # for(i in 1:n.indices){
  #   sspar(mfrow = c(1,n.indices))
  #   SSplotHCxval(retrosum, subplots = "cpue", add = TRUE, indexselect = i)
  # }
  # 
  # for(i in 1:n.comps){
  #   sspar(mfrow = c(1,n.comps))
  #   SSplotHCxval(retrocomp, subplots = "len", add = TRUE, indexselect = i)
  # }
  
}else{
  print("No information for hindcast was found")
  
}

```

## Recruitment Deviations

```{r}
#| label: recdevs
SSplotRecdevs(report., subplots = c(2,3))
```

## Likelihood Profile

```{r }
#| label: r0prof
if(dir.exists(file.path(getwd(), paste0(params$profile, "_profile")))){
  
r0.vec <- params$profile_vec
Nprofile <- length(r0.vec)
profile.str <- substr(params$profile, start=1, stop=9)
print(profile.str)
# read the output files (with names like Report1.sso, Report2.sso, etc.)
profile.dirs <- file.path(getwd(), paste0(params$profile, "_profile"))
profilemodels <- SSgetoutput(dirvec = profile.dirs,
                             keyvec = 1:Nprofile, verbose = FALSE)
# summarize output
profilesummary <- SSsummarize(profilemodels, verbose = FALSE)

# OPTIONAL COMMANDS TO ADD MODEL WITH PROFILE PARAMETER ESTIMATED
MLEmodel <- SS_output(file.path(getwd()),
                      verbose = FALSE, printstats = FALSE)
profilemodels[["MLE"]] <- MLEmodel
profilesummary <- SSsummarize(profilemodels, verbose = FALSE)
# END OPTIONAL COMMANDS

# plot profile using summary created above
SSplotProfile(profilesummary, # summary object
  profile.string = profile.str, # substring of profile parameter
  profile.label = params$profile
)

PinerPlot(profilesummary, component = "Surv_like",
          profile.string = profile.str,
          profile.label = params$profile,
          main = "Changes in survey likelihood by fleet")

delta.like <- profilesummary$likelihoods %>% 
  filter(str_detect(Label, "TOTAL")) %>% 
  pivot_longer(cols = -Label) %>%
  mutate(delta.like = value - 346.095) %>% 
  filter(str_detect(name, "MLE", negate = T)) %>% 
  mutate(linf = r0.vec)

b0 <- profilesummary$SpawnBio %>% 
  filter(str_detect(Label, "SSB_Virgin")) %>% 
  select(-c(Yr, MLE)) %>% 
  pivot_longer(cols = -c(Label))

delta.like %>% 
  left_join(b0, by = "name") %>% 
  ggplot(aes(y = value.y,x = linf, colour = linf)) + 
  geom_point()+ 
  labs(y = "B0") +
  theme_classic()

delta.like %>% 
  left_join(b0, by = "name") %>% 
  ggplot(aes(y = delta.like,x = value.y, colour = linf)) + 
  geom_point()+ 
  labs(x = "B0", y = "Change in Likelihood") +
  theme_classic()


}else{
  print("No likelihood runs were found")
  
}



```

## Management Quantities

```{r }
#| label: mvlnkb
mvln <- SSdeltaMVLN(report.)
SSplotEnsemble(mvln$kb, subplots = c("stock", "harvest", "SSB", "F"), add = TRUE)
dev.off()

```

## Jitter

```{r}
#| label: jitter

if(dir.exists(file.path(getwd(), "jitter"))){
  
  jittermods <- SSgetoutput(keyvec=1:params$Njitter,
                            dirvec=file.path(getwd(), "jitter"),
                            getcomp=FALSE, getcovar=F, verbose =FALSE)
  jittermods[["base"]] <- SS_output(file.path(getwd()),
                                    verbose = FALSE, printstats = FALSE)
  jittersum <- SSsummarize(jittermods, verbose = FALSE)

  baselike <- jittersum$likelihoods %>%
    select(base, Label) %>%
    filter(str_detect(Label, "TOTAL")) %>%
    pull(base)

  
 likes <- jittersum$likelihoods %>%
    pivot_longer(cols = -Label, names_to = "Run", values_to = "Likelihood") %>%
    filter(str_detect(Label, "TOTAL")) %>%
    mutate(Run = seq(1, params$Njitter + 1)) %>%
    ggplot(aes(x = Run, y = Likelihood)) +
    geom_point() +
    geom_hline(yintercept = baselike) +
    theme_classic()

  likes
  
}else{
  print("No jitter runs were found.")
}
  
```

```{r }
#| label: model-comparisons
if(dir.exists(file.path(getwd(), "jitter"))){
   SSplotComparisons(jittersum, subplots = c(1,7,9), new = F, legend = F)
}
```

## Selectivity and Maturity

```{r}
#| label: selectivity
#| out-width: 7.4cm

#sspar(mfrow = c(1,2))
SSplotSelex(report., subplots = c(1), mainTitle = F)
SSplotSelex(report., subplots = c(2), mainTitle = F)
```

```{r}
#| label: maturity
#| out-width: 7.2cm

#sspar(mfrow = c(1,2), mai = c(.6,.6,.1,.1))
SSplotBiology(report., subplots = c(6))
SSplotBiology(report., subplots = c(8))
```


:::
